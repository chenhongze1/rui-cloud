# RUI Common 模块职责边界重新划分方案

## 1. 现状分析

### 1.1 模块依赖冲突问题

#### 监控相关依赖重叠
- **rui-common-monitoring**: 直接依赖 `spring-boot-starter-actuator` 和 `micrometer-core`
- **rui-common-config**: 可选依赖 `spring-boot-starter-actuator` 和 `micrometer-core`
- **rui-common-tracing**: 直接依赖 `spring-boot-starter-actuator` 和 `micrometer-core`

#### 功能重叠问题
- **日志模块 vs 追踪模块**: 在链路日志记录方面存在功能重叠
- **监控模块 vs 配置模块**: 在健康检查和指标暴露方面存在重叠
- **日志模块**: 性能监控功能已标记为废弃，建议迁移到监控模块

### 1.2 模块职责边界模糊

#### 当前模块职责
- **rui-common-core**: 基础工具类和通用功能
- **rui-common-config**: 配置管理、健康检查、指标暴露
- **rui-common-log**: 日志记录、访问日志、操作日志
- **rui-common-monitoring**: 系统监控、性能监控、指标收集
- **rui-common-tracing**: 分布式链路追踪、性能监控
- **rui-common-security**: JWT认证、访问控制、安全配置

## 2. 重新划分方案

### 2.1 核心原则

1. **单一职责**: 每个模块只负责一个核心领域
2. **依赖最小化**: 减少模块间的依赖关系
3. **功能内聚**: 相关功能集中在同一模块
4. **接口分离**: 通过接口实现模块间的松耦合

### 2.2 新的模块职责划分

#### 2.2.1 rui-common-core (保持不变)
**职责**: 基础工具类和通用功能
- 通用工具类 (StringUtils, DateUtils等)
- 基础异常类
- 通用响应对象
- 基础注解

**依赖**: 仅依赖基础Spring Boot和第三方工具库

#### 2.2.2 rui-common-config (职责收缩)
**职责**: 纯配置管理
- 配置属性类
- 配置验证
- 配置刷新
- 环境配置

**移除功能**:
- 健康检查 → 移至 rui-common-monitoring
- 指标暴露 → 移至 rui-common-monitoring
- Actuator相关功能 → 移至 rui-common-monitoring

**依赖调整**:
```xml
<!-- 移除 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-core</artifactId>
</dependency>
```

#### 2.2.3 rui-common-log (职责明确)
**职责**: 纯日志记录
- 业务日志记录
- 访问日志
- 操作日志
- 安全日志
- 日志格式化和输出

**移除功能**:
- 性能监控 → 已废弃，完全移至 rui-common-monitoring
- 链路追踪相关日志 → 由 rui-common-tracing 负责

#### 2.2.4 rui-common-monitoring (职责扩展)
**职责**: 统一监控中心
- 系统监控 (CPU、内存、磁盘等)
- 应用监控 (JVM、线程池等)
- 业务监控 (自定义指标)
- 性能监控 (方法执行时间、慢查询等)
- 健康检查
- 指标收集和暴露
- Actuator端点管理

**新增功能**:
- 从 rui-common-config 迁移的健康检查功能
- 从 rui-common-log 迁移的性能监控功能
- 统一的监控配置管理

#### 2.2.5 rui-common-tracing (职责专注)
**职责**: 纯分布式链路追踪
- 链路数据采集
- 链路上下文传播
- 链路数据导出 (Jaeger、Zipkin、OTLP)
- 采样控制
- 自定义Span管理

**移除功能**:
- 性能监控 → 移至 rui-common-monitoring
- 通用指标收集 → 移至 rui-common-monitoring

**依赖调整**:
```xml
<!-- 移除 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-core</artifactId>
</dependency>
```

#### 2.2.6 rui-common-security (保持不变)
**职责**: 安全认证和授权
- JWT认证
- 访问控制
- 安全配置
- 用户管理
- 权限管理

### 2.3 模块间协作方案

#### 2.3.1 监控与日志协作
```java
// 在 rui-common-monitoring 中
@Component
public class LogMonitoringIntegration {
    
    @Autowired(required = false)
    private LogManager logManager;
    
    public void recordPerformanceLog(String operation, long duration, Map<String, Object> context) {
        // 记录性能指标
        performanceMetrics.record(operation, duration);
        
        // 如果日志模块可用，记录性能日志
        if (logManager != null) {
            logManager.performance(operation, duration, context);
        }
    }
}
```

#### 2.3.2 监控与追踪协作
```java
// 在 rui-common-monitoring 中
@Component
public class TracingMonitoringIntegration {
    
    @EventListener
    public void onSpanEnd(SpanEndEvent event) {
        // 从Span中提取性能指标
        String operation = event.getSpan().getName();
        long duration = event.getSpan().getDuration();
        
        // 记录到监控系统
        performanceMetrics.record(operation, duration);
    }
}
```

## 3. 实施计划

### 3.1 第一阶段：依赖清理

1. **清理 rui-common-config 模块**
   - 移除 actuator 和 micrometer 依赖
   - 移除健康检查相关代码
   - 移除指标暴露相关代码

2. **清理 rui-common-tracing 模块**
   - 移除 actuator 和 micrometer 依赖
   - 移除性能监控相关代码
   - 专注于链路追踪功能

### 3.2 第二阶段：功能迁移

1. **迁移健康检查功能**
   - 从 rui-common-config 迁移到 rui-common-monitoring
   - 保持API兼容性

2. **迁移性能监控功能**
   - 从 rui-common-log 迁移到 rui-common-monitoring
   - 从 rui-common-tracing 迁移到 rui-common-monitoring

### 3.3 第三阶段：集成测试

1. **模块独立测试**
   - 确保每个模块可以独立启动
   - 验证核心功能正常

2. **集成测试**
   - 测试模块间协作
   - 验证依赖冲突已解决

## 4. 配置调整

### 4.1 应用配置调整

```yaml
rui:
  # 配置模块 - 仅配置管理
  config:
    enabled: true
    refresh-enabled: true
    
  # 日志模块 - 纯日志记录
  log:
    enabled: true
    access-log-enabled: true
    operation-log-enabled: true
    
  # 监控模块 - 统一监控
  monitoring:
    enabled: true
    performance-enabled: true
    health-check-enabled: true
    metrics-enabled: true
    
  # 追踪模块 - 纯链路追踪
  tracing:
    enabled: true
    sampling-rate: 0.1
    export-type: jaeger
    
  # 安全模块
  security:
    enabled: true
    jwt-enabled: true
```

### 4.2 依赖引入调整

```xml
<!-- 应用只需引入需要的模块 -->
<dependencies>
    <!-- 基础模块 -->
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-core</artifactId>
    </dependency>
    
    <!-- 根据需要选择性引入 -->
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-config</artifactId>
    </dependency>
    
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-log</artifactId>
    </dependency>
    
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-monitoring</artifactId>
    </dependency>
    
    <!-- 可选模块 -->
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-tracing</artifactId>
        <optional>true</optional>
    </dependency>
    
    <dependency>
        <groupId>com.rui</groupId>
        <artifactId>rui-common-security</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

## 5. 预期效果

### 5.1 解决的问题

1. **依赖冲突**: 消除 actuator 和 micrometer 的重复依赖
2. **功能重叠**: 明确各模块职责边界
3. **启动问题**: 解决因依赖冲突导致的启动失败
4. **维护复杂度**: 降低模块间的耦合度

### 5.2 带来的好处

1. **模块化**: 真正实现模块化架构
2. **可选性**: 应用可以选择性引入需要的模块
3. **可维护性**: 每个模块职责清晰，便于维护
4. **可扩展性**: 便于后续功能扩展

## 6. 风险评估

### 6.1 兼容性风险

- **API变更**: 部分API可能需要调整
- **配置变更**: 配置项可能需要迁移

### 6.2 迁移风险

- **功能缺失**: 迁移过程中可能遗漏功能
- **测试覆盖**: 需要充分的测试覆盖

### 6.3 风险缓解

1. **渐进式迁移**: 分阶段实施，降低风险
2. **向后兼容**: 保持关键API的向后兼容性
3. **充分测试**: 每个阶段都进行充分测试
4. **文档更新**: 及时更新使用文档

## 7. 总结

通过重新划分模块职责边界，可以有效解决当前的依赖冲突和功能重叠问题，实现真正的模块化架构。关键是要坚持单一职责原则，明确各模块的核心职能，通过接口实现模块间的松耦合协作。